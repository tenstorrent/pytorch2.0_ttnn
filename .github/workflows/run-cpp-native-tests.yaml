name: "C++ Extension Tests"

on:
  push:
    branches:
      - main
    paths:
      - 'torch_ttnn/cpp_extension/**'
      - 'tests/cpp_extension/**'
      - 'pyproject.toml'  # Trigger on ttnn dependency updates
  pull_request:
    paths:
      - 'torch_ttnn/cpp_extension/**'
      - 'tests/cpp_extension/**'
      - 'pyproject.toml'  # Trigger on ttnn dependency updates
  workflow_dispatch:
    inputs:
      docker_tag:
        description: "Docker container tag to use"
        required: false
        type: string
        default: "ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-ci-test-amd64:latest"

jobs:
  cpp-extension-tests:
    runs-on: ["in-service", "nfs"]
    container:
      image: ${{ github.event.inputs.docker_tag || 'ghcr.io/tenstorrent/tt-metal/tt-metalium/ubuntu-22.04-ci-test-amd64:latest' }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: >-
        --rm -v /dev/hugepages-1G:/dev/hugepages-1G --device /dev/tenstorrent
        -v ${{ github.workspace }}:${{ github.workspace }} -w ${{ github.workspace }}
        -v /mnt/tt-metal-pytorch-cache/.cache:/root/.cache
    env:
      CCACHE_DIR: /root/.cache/ccache
      CPM_SOURCE_CACHE: /root/.cache/cpm
      CCACHE_BASEDIR: ${{ github.workspace }}
      CCACHE_MAXSIZE: 30G
      PYTHON_ENV_DIR: ${{ github.workspace }}/torch_ttnn/cpp_extension/third-party/tt-metal/python_env
    defaults:
      run:
        shell: bash
    steps:
      - name: Prepare checkout
        run: |
          set -euxo pipefail
          apt-get update
          apt-get install -y git-lfs
          git lfs install

      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
          submodules: recursive

      - name: Synchronise tt-metal submodule
        run: |
          set -eux
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"
          git config --global --add safe.directory '*'
          
          # SUPER-CLEAN CHECKOUT: Remove and re-clone submodule
          # Prevents stale ref errors when tt-metal force-pushes branches
          TT_METAL_PATH="torch_ttnn/cpp_extension/third-party/tt-metal"
          
          rm -rf "${TT_METAL_PATH}"
          git submodule deinit -f "${TT_METAL_PATH}" 2>/dev/null || true
          git submodule sync --recursive
          git submodule update --init --force "${TT_METAL_PATH}"
          
          cd "${TT_METAL_PATH}"
          git fetch --all --tags --force --prune
          
          # Nested submodules: tolerate stale refs (common when upstream force-pushes)
          set +e
          git submodule sync --recursive
          git submodule update --init --recursive --force
          set -e
          
          git lfs fetch --all || true
          git lfs pull || true
          
          echo "âœ“ TT-Metal: $(git log --oneline -1)"

      - name: Install system dependencies
        run: |
          set -euxo pipefail
          apt-get update
          apt-get install -y build-essential clang-17 clang-format-17 llvm-17-dev gcc-12 g++-12 cmake ninja-build \
            python3 python3-venv python3-pip curl jq ccache nlohmann-json3-dev

      - name: Configure ccache
        run: |
          set -euxo pipefail
          mkdir -p "${CCACHE_DIR}"
          ccache --set-config=cache_dir="${CCACHE_DIR}"
          if [[ -n "${CCACHE_MAXSIZE:-}" ]]; then
            ccache --set-config=max_size="${CCACHE_MAXSIZE}"
          fi
          if [[ -n "${CCACHE_BASEDIR:-}" ]]; then
            ccache --set-config=base_dir="${CCACHE_BASEDIR}"
          fi
          ccache --set-config=compression=true
          ccache --zero-stats

      - name: Build and test
        run: |
          set -euxo pipefail
          # NOTE: TT_METAL_HOME is not exported (CMake auto-detects from submodule)
          TT_METAL_DIR="${{ github.workspace }}/torch_ttnn/cpp_extension/third-party/tt-metal"
          export PYTHON_ENV_DIR="${{ env.PYTHON_ENV_DIR }}"
          export CPM_SOURCE_CACHE="${{ env.CPM_SOURCE_CACHE }}"
          export TT_METAL_TOOLS_DIR="${TT_METAL_DIR}/.local/bin"
          export CC="$(command -v clang-17)"
          export CXX="$(command -v clang++-17)"
          export CMAKE_C_COMPILER="${CC}"
          export CMAKE_CXX_COMPILER="${CXX}"
          export CMAKE_MAKE_PROGRAM="$(command -v ninja)"
          mkdir -p "${CPM_SOURCE_CACHE}" "${TT_METAL_TOOLS_DIR}"
          export PATH="${TT_METAL_TOOLS_DIR}:${PATH}"
          
          cd "${TT_METAL_DIR}"
          ./install_dependencies.sh
          rm -rf build build_Release "${PYTHON_ENV_DIR}"
          ./build_metal.sh --release --enable-ccache
          ./create_venv.sh
          source "${PYTHON_ENV_DIR}/bin/activate"
          export PATH="${TT_METAL_TOOLS_DIR}:${PATH}"
          python -m pip config set global.extra-index-url https://download.pytorch.org/whl/cpu
          python -m pip install --upgrade pip
          python -m pip install --upgrade "scikit-build-core<0.11" cmake ninja
          # Install torch-ttnn: [pypi,dev] for ttnn updates, [dev] for regular builds
          if git log --oneline -1 | grep -q "Update dependencies to"; then
            python -m pip install -e "${GITHUB_WORKSPACE}"[pypi,dev]
          else
            python -m pip install -e "${GITHUB_WORKSPACE}"[dev]
          fi
          
          # Run tests (no LD_LIBRARY_PATH needed - RPATH configured automatically)
          python -m pytest "${GITHUB_WORKSPACE}/tests/cpp_extension/test_cpp_extension_functionality.py" -v
          python -m pytest "${GITHUB_WORKSPACE}/tests/cpp_extension/test_bert_cpp_extension.py" -v
          python -m pytest "${GITHUB_WORKSPACE}/tests/models" --native_integration -v
          ccache --show-stats

  tests-passed:
    if: ${{ always() }}
    outputs:
      didpass: ${{ steps.check.outputs.didpass }}
    runs-on: ubuntu-latest
    needs: [cpp-extension-tests]
    steps:
      - id: check
        run: |
          cpp_tests_result="${{ needs.cpp-extension-tests.result }}"
          if [[ $cpp_tests_result == "success" || $cpp_tests_result == "skipped" ]]; then
            echo "didpass=0" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "didpass=1" >> $GITHUB_OUTPUT
            exit 1
          fi
